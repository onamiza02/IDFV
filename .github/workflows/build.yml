name: Build iOS Tweak

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Theos
      uses: Randomblock1/theos-action@v1

    - name: Create Preferences.framework stub
      run: |
        # Find the SDK being used
        SDK_PATH=$(find $THEOS/sdks -maxdepth 1 -type d -name "iPhoneOS*.sdk" | sort -V | tail -1)
        echo "Using SDK: $SDK_PATH"
        
        # Create PrivateFrameworks directory if it doesn't exist
        mkdir -p "$SDK_PATH/System/Library/PrivateFrameworks/Preferences.framework"
        
        # Create TBD stub for Preferences.framework
        cat > "$SDK_PATH/System/Library/PrivateFrameworks/Preferences.framework/Preferences.tbd" << 'TBD'
        --- !tapi-tbd
        tbd-version:     4
        targets:         [ arm64-ios, arm64e-ios ]
        install-name:    '/System/Library/PrivateFrameworks/Preferences.framework/Preferences'
        current-version: 1
        compatibility-version: 1
        exports:
          - targets:     [ arm64-ios, arm64e-ios ]
            objc-classes:
              - PSListController
              - PSSpecifier
              - PSTableCell
              - PSViewController
              - PSListItemsController
              - PSSwitchTableCell
              - PSEditableTableCell
        ...
        TBD
        
        echo "Created Preferences.framework stub at:"
        ls -la "$SDK_PATH/System/Library/PrivateFrameworks/Preferences.framework/"

    - name: Build Package
      run: |
        make package FINALPACKAGE=1 THEOS_PACKAGE_SCHEME=rootless

    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: IDFVSpoofer-rootless
        path: packages/*.deb

    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v2
      with:
        files: packages/*.deb
        generate_release_notes: true
